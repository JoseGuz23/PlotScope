#!/usr/bin/env python3
"""
test_gcp_connection.py - Verifica que GCP estÃ© bien configurado
"""

import os
import json

def main():
    print("\n" + "=" * 60)
    print("  ğŸ”§ TEST DE CONEXIÃ“N A GCP")
    print("=" * 60 + "\n")
    
    errors = []
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1. VERIFICAR VARIABLES DE ENTORNO
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("1ï¸âƒ£ Verificando variables de entorno...\n")
    
    # Intentar cargar de local.settings.json
    local_settings_path = 'local.settings.json'
    settings = {}
    
    if os.path.exists(local_settings_path):
        with open(local_settings_path, 'r', encoding='utf-8') as f:
            settings = json.load(f).get('Values', {})
        print(f"   âœ… local.settings.json encontrado")
    else:
        print(f"   âš ï¸ local.settings.json no encontrado, usando variables de entorno")
    
    # Variables requeridas
    required_vars = {
        'GCP_PROJECT_ID': settings.get('GCP_PROJECT_ID') or os.environ.get('GCP_PROJECT_ID'),
        'GCP_BUCKET_NAME': settings.get('GCP_BUCKET_NAME') or os.environ.get('GCP_BUCKET_NAME'),
        'GOOGLE_APPLICATION_CREDENTIALS_JSON': settings.get('GOOGLE_APPLICATION_CREDENTIALS_JSON') or os.environ.get('GOOGLE_APPLICATION_CREDENTIALS_JSON'),
    }
    
    for var, value in required_vars.items():
        if value:
            if var == 'GOOGLE_APPLICATION_CREDENTIALS_JSON':
                print(f"   âœ… {var}: (JSON de {len(value)} caracteres)")
            else:
                print(f"   âœ… {var}: {value}")
        else:
            print(f"   âŒ {var}: NO CONFIGURADA")
            errors.append(f"Falta {var}")
    
    if errors:
        print(f"\nâŒ Faltan variables. AgrÃ©galas a local.settings.json:")
        print("""
{
  "Values": {
    "GCP_PROJECT_ID": "tu-proyecto-id",
    "GCP_BUCKET_NAME": "tu-bucket-name",
    "GOOGLE_APPLICATION_CREDENTIALS_JSON": "{\\"type\\": \\"service_account\\", ...}"
  }
}
        """)
        return False
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 2. VERIFICAR CREDENCIALES JSON
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("\n2ï¸âƒ£ Verificando credenciales JSON...\n")
    
    creds_json = required_vars['GOOGLE_APPLICATION_CREDENTIALS_JSON']
    try:
        creds = json.loads(creds_json)
        print(f"   âœ… JSON vÃ¡lido")
        print(f"   âœ… Tipo: {creds.get('type', 'N/A')}")
        print(f"   âœ… Project: {creds.get('project_id', 'N/A')}")
        print(f"   âœ… Client email: {creds.get('client_email', 'N/A')[:40]}...")
        
        # Guardar temporalmente para las pruebas
        creds_path = 'temp_gcp_creds.json'
        with open(creds_path, 'w') as f:
            f.write(creds_json)
        os.environ['GOOGLE_APPLICATION_CREDENTIALS'] = creds_path
        
    except json.JSONDecodeError as e:
        print(f"   âŒ JSON invÃ¡lido: {e}")
        errors.append("JSON de credenciales invÃ¡lido")
        return False
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 3. PROBAR CONEXIÃ“N A CLOUD STORAGE
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("\n3ï¸âƒ£ Probando conexiÃ³n a Cloud Storage...\n")
    
    try:
        from google.cloud import storage
        
        project_id = required_vars['GCP_PROJECT_ID']
        bucket_name = required_vars['GCP_BUCKET_NAME']
        
        client = storage.Client(project=project_id)
        bucket = client.bucket(bucket_name)
        
        # Verificar que el bucket existe
        if bucket.exists():
            print(f"   âœ… Bucket '{bucket_name}' existe y es accesible")
        else:
            print(f"   âŒ Bucket '{bucket_name}' NO existe")
            print(f"      CrÃ©alo en: https://console.cloud.google.com/storage/browser")
            errors.append("Bucket no existe")
            
    except ImportError:
        print(f"   âŒ google-cloud-storage no instalado")
        print(f"      Ejecuta: pip install google-cloud-storage")
        errors.append("LibrerÃ­a no instalada")
    except Exception as e:
        print(f"   âŒ Error: {e}")
        errors.append(str(e))
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 4. PROBAR CONEXIÃ“N A VERTEX AI
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("\n4ï¸âƒ£ Probando conexiÃ³n a Vertex AI...\n")
    
    try:
        from google.cloud import aiplatform
        
        aiplatform.init(project=project_id, location="us-central1")
        print(f"   âœ… Vertex AI inicializado")
        print(f"   âœ… Project: {project_id}")
        print(f"   âœ… Location: us-central1")
        
    except ImportError:
        print(f"   âŒ google-cloud-aiplatform no instalado")
        print(f"      Ejecuta: pip install google-cloud-aiplatform")
        errors.append("LibrerÃ­a no instalada")
    except Exception as e:
        print(f"   âŒ Error: {e}")
        errors.append(str(e))
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 5. RESUMEN
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("\n" + "=" * 60)
    
    # Limpiar archivo temporal
    if os.path.exists('temp_gcp_creds.json'):
        os.remove('temp_gcp_creds.json')
    
    if errors:
        print("  âŒ HAY ERRORES - CORRIGE ANTES DE CONTINUAR")
        print("=" * 60)
        for err in errors:
            print(f"  â€¢ {err}")
        return False
    else:
        print("  âœ… TODO LISTO - PUEDES CORRER BATCH API")
        print("=" * 60)
        print("\n  Siguiente paso:")
        print("  1. AsegÃºrate que USE_BATCH_API = True en Orchestrator")
        print("  2. Despliega: func azure functionapp publish sylphrena-orchestrator")
        print("  3. Corre: python test_mvp_v2.py")
        return True


if __name__ == "__main__":
    main()